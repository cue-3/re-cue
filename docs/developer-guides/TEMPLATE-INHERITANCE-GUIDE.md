# Template Inheritance System Guide

## Overview

The RE-cue template inheritance system leverages Jinja2's powerful `extends` and `include` directives to enable:

- **Template Reuse**: Define base templates with common structure
- **Block Overrides**: Child templates can override specific sections
- **Reusable Components**: Share common elements across templates via includes
- **Consistent Structure**: Maintain uniform documentation format
- **Easy Maintenance**: Update common sections in one place

This guide explains how to use template inheritance in your RE-cue projects.

---

## Table of Contents

1. [Quick Start](#quick-start)
2. [Template Inheritance Basics](#template-inheritance-basics)
3. [Using Base Templates](#using-base-templates)
4. [Reusable Components](#reusable-components)
5. [Framework-Specific Templates](#framework-specific-templates)
6. [Advanced Patterns](#advanced-patterns)
7. [Best Practices](#best-practices)
8. [Examples](#examples)
9. [Backward Compatibility](#backward-compatibility)

---

## Quick Start

### Creating a Template with Inheritance

```jinja2
{% extends "base.md" %}

{% block title %}My Custom Analysis - {{ PROJECT_NAME }}{% endblock %}

{% block main_content %}
## My Analysis Results

{% for item in items %}
- {{ item.name }}: {{ item.value }}
{% endfor %}
{% endblock %}
```

### Using a Template with Inheritance

```python
from reverse_engineer.templates.template_loader import TemplateLoader

loader = TemplateLoader()
output = loader.render_template(
    'my-analysis.md',
    PROJECT_NAME='MyApp',
    DATE='2024-12-11',
    items=[
        {'name': 'Endpoints', 'value': 10},
        {'name': 'Models', 'value': 5}
    ]
)
```

---

## Template Inheritance Basics

### The `extends` Directive

The `extends` directive allows a template to inherit from a parent template:

```jinja2
{% extends "base.md" %}
```

**Rules:**
- Must be the first statement in the template (except comments)
- Can only extend one parent template
- Parent template is searched in the template path hierarchy

### The `block` Directive

Blocks define sections that can be overridden by child templates:

**Parent Template (base.md):**
```jinja2
# {% block title %}Default Title{% endblock %}

{% block content %}
Default content
{% endblock %}
```

**Child Template:**
```jinja2
{% extends "base.md" %}

{% block title %}Custom Title{% endblock %}

{% block content %}
Custom content that replaces default
{% endblock %}
```

**Output:**
```markdown
# Custom Title

Custom content that replaces default
```

### The `super()` Function

Use `super()` to include parent block content:

```jinja2
{% extends "base.md" %}

{% block content %}
{{ super() }}

Additional content after parent content
{% endblock %}
```

---

## Using Base Templates

### Common Base Template (`base.md`)

The `base.md` template provides a standard structure for all documentation:

**Structure:**
```jinja2
{% block header %}
# {% block title %}{{ PROJECT_NAME }}{% endblock %}
**Generated**: {{ DATE }}
{% endblock %}

{% block overview %}
## Overview
{% block overview_content %}...{% endblock %}
{% endblock %}

{% block main_content %}
{# Main content goes here #}
{% endblock %}

{% block footer %}
*Generated by RE-cue*
{% endblock %}
```

**Available Blocks:**
- `header` - Document header with title and metadata
- `title` - Document title only
- `overview` - Overview section
- `overview_content` - Overview text
- `overview_stats` - Statistics in overview
- `main_content` - Main document content
- `next_steps` - Next steps section
- `footer` - Document footer

### Framework Section Base (`base_framework_section.md`)

For framework-specific sections:

```jinja2
{% extends "base_framework_section.md" %}

{% block framework_name %}Java Spring Boot{% endblock %}
{% block section_title %}Endpoints{% endblock %}

{% block summary_table_rows %}
{% for endpoint in endpoints %}
| {{ endpoint.method }} | {{ endpoint.path }} |
{% endfor %}
{% endblock %}
```

---

## Reusable Components

### The `include` Directive

Include reusable components in your templates:

```jinja2
{% include "_stats_table.md" %}
```

### Available Components

#### 1. Statistics Table (`_stats_table.md`)

Display a formatted statistics table:

```jinja2
{% include "_stats_table.md" %}
```

**Required Variables:**
- `stats` (dict) - Statistics to display

**Example:**
```python
stats = {
    'endpoint_count': 10,
    'model_count': 5,
    'actor_count': 3
}
```

#### 2. Footer (`_footer.md`)

Standard document footer with generation info:

```jinja2
{% include "_footer.md" %}
```

**Optional Variables:**
- `DATE` - Generation date
- `TOOL_VERSION` - Tool version
- `ANALYSIS_DURATION` - How long analysis took

#### 3. Warning Banner (`_warning.md`)

Display warnings or important notices:

```jinja2
{% include "_warning.md" %}
```

**Variables:**
- `warning` (string) - Single warning message
- `warnings` (list) - Multiple warning messages

**Example:**
```python
warnings = [
    'Incomplete analysis',
    'Some files skipped',
    'Review manually'
]
```

### Creating Custom Components

Place component templates in your template directory with `_` prefix:

**`_my_component.md`:**
```jinja2
{% if my_data %}
## My Custom Component

{{ my_data }}
{% endif %}
```

**Use it:**
```jinja2
{% include "_my_component.md" %}
```

---

## Framework-Specific Templates

### Extending Framework Base

```jinja2
{% extends "base_framework_section.md" %}

{% block framework_name %}Python Django{% endblock %}
{% block section_title %}Views{% endblock %}

{% block summary_table_header %}
| View | Type | URL Pattern |
|------|------|-------------|
{% endblock %}

{% block summary_table_rows %}
{% for view in views %}
| {{ view.name }} | {{ view.type }} | {{ view.url }} |
{% endfor %}
{% endblock %}
```

### Framework-Specific Components

Create framework-specific includes:

**`frameworks/java_spring/_spring_annotations.md`:**
```jinja2
## Spring Annotations

{% for annotation in spring_annotations %}
- **{{ annotation.name }}**: {{ annotation.description }}
{% endfor %}
```

**Use it:**
```jinja2
{% include "_spring_annotations.md" %}
```

---

## Advanced Patterns

### Multi-Level Inheritance

Child templates can extend other child templates:

**`base.md`** → **`analysis_base.md`** → **`phase1_custom.md`**

```jinja2
{# analysis_base.md #}
{% extends "base.md" %}

{% block overview %}
{{ super() }}

**Analysis Type**: {{ ANALYSIS_TYPE }}
{% endblock %}
```

```jinja2
{# phase1_custom.md #}
{% extends "analysis_base.md" %}

{% block main_content %}
Custom Phase 1 content
{% endblock %}
```

### Conditional Inheritance

Use variables to control inheritance:

```jinja2
{% if custom_base %}
{% extends custom_base %}
{% else %}
{% extends "base.md" %}
{% endif %}
```

### Block Nesting

Blocks can be nested:

```jinja2
{% block outer %}
Outer content

  {% block inner %}
  Inner content
  {% endblock %}

More outer content
{% endblock %}
```

### Macros with Inheritance

Define reusable macros in base templates:

```jinja2
{# base.md #}
{% macro render_table(items) %}
| Name | Value |
|------|-------|
{% for item in items %}
| {{ item.name }} | {{ item.value }} |
{% endfor %}
{% endmacro %}
```

```jinja2
{# child.md #}
{% extends "base.md" %}

{% block content %}
{{ render_table(my_items) }}
{% endblock %}
```

---

## Best Practices

### 1. Use Meaningful Block Names

✅ **Good:**
```jinja2
{% block endpoint_summary %}
{% block model_details %}
{% block security_annotations %}
```

❌ **Bad:**
```jinja2
{% block section1 %}
{% block data %}
{% block stuff %}
```

### 2. Keep Base Templates Generic

Base templates should be reusable across different scenarios:

✅ **Good:**
```jinja2
{% block main_content %}
{# Child templates define content #}
{% endblock %}
```

❌ **Bad:**
```jinja2
{% block main_content %}
Specific hardcoded content
{% endblock %}
```

### 3. Use Includes for Repeated Elements

If the same structure appears in multiple templates, extract it:

✅ **Good:**
```jinja2
{% include "_stats_table.md" %}
```

❌ **Bad:** Copy-paste the same table structure in every template

### 4. Document Your Blocks

Add comments to describe block purpose:

```jinja2
{% block custom_metrics %}
{#
  Override this block to add custom metrics.
  Expected variables:
  - metrics (list): List of metric objects
#}
{% endblock %}
```

### 5. Provide Sensible Defaults

Base templates should work without requiring all blocks to be overridden:

```jinja2
{% block footer %}
*Generated by RE-cue on {{ DATE | default('Unknown date') }}*
{% endblock %}
```

### 6. Follow Naming Conventions

- Base templates: `base*.md`
- Includes/partials: `_*.md` (underscore prefix)
- Extended templates: `*-extended.md` or descriptive name

---

## Examples

### Example 1: Custom Analysis Template

```jinja2
{% extends "base.md" %}

{% block title %}Security Analysis - {{ PROJECT_NAME }}{% endblock %}

{% block overview_content %}
This document contains security analysis results.
{% endblock %}

{% block overview_stats %}
{% include "_stats_table.md" %}
{% endblock %}

{% block main_content %}
## Vulnerabilities

{% if vulnerabilities %}
{% for vuln in vulnerabilities %}
### {{ vuln.severity | upper }}: {{ vuln.title }}

- **Location**: {{ vuln.file }}:{{ vuln.line }}
- **Description**: {{ vuln.description }}
- **Recommendation**: {{ vuln.fix }}

{% endfor %}
{% else %}
✅ No vulnerabilities found!
{% endif %}

---

{% include "_warning.md" %}
{% endblock %}

{% block footer %}
{% include "_footer.md" %}
{% endblock %}
```

### Example 2: Framework Comparison Template

```jinja2
{% extends "base.md" %}

{% block title %}Framework Comparison{% endblock %}

{% block main_content %}
{% for framework in frameworks %}
## {{ framework.name }}

{% include "_stats_table.md" with context %}

### Strengths
{% for strength in framework.strengths %}
- {{ strength }}
{% endfor %}

### Weaknesses
{% for weakness in framework.weaknesses %}
- {{ weakness }}
{% endfor %}

---
{% endfor %}
{% endblock %}
```

### Example 3: Multi-Language Support

```jinja2
{% extends "base.md" %}

{% block title %}
{% if language == 'es' %}
Análisis del Proyecto - {{ PROJECT_NAME }}
{% elif language == 'fr' %}
Analyse du Projet - {{ PROJECT_NAME }}
{% else %}
Project Analysis - {{ PROJECT_NAME }}
{% endif %}
{% endblock %}

{% block main_content %}
{% if language == 'es' %}
{% include "content_es.md" %}
{% elif language == 'fr' %}
{% include "content_fr.md" %}
{% else %}
{% include "content_en.md" %}
{% endif %}
{% endblock %}
```

---

## Backward Compatibility

### Old Templates Continue to Work

Existing templates without inheritance work unchanged:

```jinja2
{# old-template.md - Still works! #}
# {{PROJECT_NAME}}

**Date**: {{DATE}}

## Results

{{RESULTS}}
```

### Gradual Migration

You can migrate templates incrementally:

1. Keep old templates as-is
2. Create new `-extended.md` versions using inheritance
3. Migrate generators to use new templates when ready
4. Old templates remain available for compatibility

### Mixed Usage

You can use both old and new templates in the same project:

```python
# Old style
output1 = loader.render_template('phase1-structure.md', ...)

# New style with inheritance
output2 = loader.render_template('phase1-structure-extended.md', ...)
```

---

## Template Loader Support

The `TemplateLoader` class automatically supports inheritance:

```python
from reverse_engineer.templates.template_loader import TemplateLoader

# Basic usage
loader = TemplateLoader()

# With framework
loader = TemplateLoader(framework_id='java_spring')

# With custom templates
loader = TemplateLoader(custom_template_dir='/path/to/templates')

# Render template (inheritance works automatically)
output = loader.render_template('my-template.md', **variables)
```

**Template Search Path:**
1. Custom directory (if specified)
2. Framework directory (if framework specified)
3. Common directory

This search path applies to `extends` and `include` directives.

---

## Troubleshooting

### Template Not Found

**Error:** `jinja2.exceptions.TemplateNotFound: 'base.md'`

**Solution:** Ensure base template exists in search path:
```python
loader = TemplateLoader()
print(loader.exists('base.md'))  # Should be True
```

### Circular Inheritance

**Error:** Circular inheritance detected

**Solution:** Check your extends chain - no template should extend itself indirectly:
```jinja2
{# BAD - Don't do this! #}
a.md extends b.md
b.md extends c.md
c.md extends a.md  # Circular!
```

### Block Not Rendering

**Problem:** Block content not appearing in output

**Solution:** Verify block names match between parent and child:
```jinja2
{# Parent #}
{% block content %}...{% endblock %}

{# Child - typo in block name! #}
{% block conten %}...{% endblock %}  {# Won't override #}
```

### Include Not Found

**Error:** Template for include not found

**Solution:** Ensure included template exists:
```python
loader.exists('_stats_table.md')  # Check it exists
```

---

## Summary

Template inheritance in RE-cue provides:

✅ **Reduced Duplication** - Define common structure once  
✅ **Consistent Output** - All documents follow same format  
✅ **Easy Maintenance** - Update base templates, all children update  
✅ **Flexible Customization** - Override only what you need  
✅ **Reusable Components** - Share common elements via includes  
✅ **Full Backward Compatibility** - Old templates still work  

**Next Steps:**
- Review the example templates in `templates/common/`
- Try creating a custom template using inheritance
- Explore framework-specific examples
- Read the [Jinja2 Template Guide](./JINJA2-TEMPLATE-GUIDE.md) for more features

---

**Related Documentation:**
- [Jinja2 Template Guide](./JINJA2-TEMPLATE-GUIDE.md)
- [Jinja2 Generator Examples](./JINJA2-GENERATOR-EXAMPLES.md)
- [Template Customization Guide](./TEMPLATE-CUSTOMIZATION.md)
- [ENH-TMPL-001 Implementation](./ENH-TMPL-001-IMPLEMENTATION-SUMMARY.md)

---

*Last Updated: December 11, 2024*  
*Feature: ENH-TMPL-003 - Template Inheritance System*
