name: Track Label Changes for Learning

on:
  pull_request:
    types: [labeled, unlabeled, closed]

permissions:
  contents: read
  pull-requests: read

jobs:
  track-changes:
    name: Track Label Corrections
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event.action == 'labeled' || github.event.action == 'unlabeled'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get PR label history
        id: history
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}  # pragma: allowlist secret
          script: |
            const prNumber = context.payload.pull_request.number;
            
            // Get all events for this PR
            const { data: events } = await github.rest.issues.listEvents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            
            // Filter label events
            const labelEvents = events.filter(e => 
              e.event === 'labeled' || e.event === 'unlabeled'
            ).filter(e => 
              e.label && e.label.name.startsWith('type: ')
            );
            
            // Get timeline of label changes
            const timeline = labelEvents.map(e => ({
              action: e.event,
              label: e.label.name,
              timestamp: e.created_at,
              actor: e.actor.login,
              actorType: e.actor.type
            }));
            
            // Identify auto-applied vs manual labels
            const autoApplied = timeline.filter(t => 
              t.actor === 'github-actions[bot]' || 
              t.actorType === 'Bot'
            );
            
            const manualChanges = timeline.filter(t => 
              t.actor !== 'github-actions[bot]' && 
              t.actorType !== 'Bot'
            );
            
            core.setOutput('timeline', JSON.stringify(timeline));
            core.setOutput('auto_applied', JSON.stringify(autoApplied));
            core.setOutput('manual_changes', JSON.stringify(manualChanges));
            
            return {
              prNumber,
              timeline,
              autoApplied,
              manualChanges
            };
      
      - name: Calculate accuracy metrics
        id: metrics
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            const timeline = JSON.parse('${{ steps.history.outputs.timeline }}');
            const autoApplied = JSON.parse('${{ steps.history.outputs.auto_applied }}');
            const manualChanges = JSON.parse('${{ steps.history.outputs.manual_changes }}');
            
            // Get final labels
            const pr = context.payload.pull_request;
            const finalLabels = pr.labels
              .filter(l => l.name.startsWith('type: '))
              .map(l => l.name);
            
            // Calculate metrics per label
            const metrics = {};
            const allLabelTypes = [
              'type: breaking',
              'type: enhancement',
              'type: bug',
              'type: documentation',
              'type: dependencies',
              'type: chore',
              'type: security',
              'type: performance'
            ];
            
            for (const labelType of allLabelTypes) {
              const autoAppliedThis = autoApplied.some(a => 
                a.action === 'labeled' && a.label === labelType
              );
              const inFinalLabels = finalLabels.includes(labelType);
              const wasRemoved = manualChanges.some(m => 
                m.action === 'unlabeled' && m.label === labelType
              );
              const wasAdded = manualChanges.some(m => 
                m.action === 'labeled' && m.label === labelType
              );
              
              metrics[labelType] = {
                auto_applied: autoAppliedThis,
                in_final: inFinalLabels,
                manually_removed: wasRemoved,
                manually_added: wasAdded,
                correct: autoAppliedThis && inFinalLabels && !wasRemoved,
                false_positive: autoAppliedThis && wasRemoved,
                false_negative: !autoAppliedThis && wasAdded
              };
            }
            
            const report = {
              pr_number: pr.number,
              pr_title: pr.title,
              pr_merged_at: pr.merged_at,
              timeline,
              final_labels: finalLabels,
              metrics,
              summary: {
                total_auto_applied: autoApplied.filter(a => a.action === 'labeled').length,
                total_manual_changes: manualChanges.length,
                correct_predictions: Object.values(metrics).filter(m => m.correct).length,
                false_positives: Object.values(metrics).filter(m => m.false_positive).length,
                false_negatives: Object.values(metrics).filter(m => m.false_negative).length
              }
            };
            
            core.setOutput('report', JSON.stringify(report));
            return report;
      
      - name: Save accuracy report to artifact
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const report = JSON.parse('${{ steps.metrics.outputs.report }}');
            
            // Create reports directory
            const reportsDir = path.join(process.env.GITHUB_WORKSPACE, 'label-accuracy-reports');
            if (!fs.existsSync(reportsDir)) {
              fs.mkdirSync(reportsDir, { recursive: true });
            }
            
            // Save report with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = 'pr-' + report.pr_number + '-' + timestamp + '.json';
            const filepath = path.join(reportsDir, filename);
            
            fs.writeFileSync(filepath, JSON.stringify(report, null, 2));
            core.info('Saved accuracy report to ' + filepath);
      
      - name: Upload accuracy report artifact
        if: github.event.pull_request.merged == true
        uses: actions/upload-artifact@v4
        with:
          name: label-accuracy-report-pr-${{ github.event.pull_request.number }}
          path: label-accuracy-reports/*.json
          retention-days: 90
      
      - name: Log real-time feedback
        if: github.event.action == 'labeled' || github.event.action == 'unlabeled'
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.payload;
            const action = event.action;
            const label = event.label.name;
            const actor = event.sender.login;
            const actorType = event.sender.type;
            
            if (!label.startsWith('type: ')) {
              core.info('Not a category label, skipping');
              return;
            }
            
            const isBot = actorType === 'Bot' || actor === 'github-actions[bot]';
            const actionType = isBot ? 'auto' : 'manual';
            
            core.info('Label ' + action + ': ' + label + ' (' + actionType + ' by ' + actor + ')');
            
            // This provides real-time visibility into label changes
            // Future enhancement: Could send to analytics service
