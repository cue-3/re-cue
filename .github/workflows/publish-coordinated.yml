name: Coordinated Release

on:
  push:
    tags:
      - 'v*'
      - '!v*-rc*'
      - '!v*-beta*'
      - '!v*-alpha*'

permissions:
  contents: write
  pull-requests: read
  issues: write

jobs:
  extract-version:
    name: Extract Version from Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      previous_tag: ${{ steps.previous.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $TAG"
      
      - name: Get previous tag
        id: previous
        run: |
          PREVIOUS=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          echo "tag=$PREVIOUS" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREVIOUS"
  
  generate-changelog:
    name: Generate Changelog
    needs: extract-version
    uses: ./.github/workflows/generate-changelog.yml
    with:
      previous_tag: ${{ needs.extract-version.outputs.previous_tag }}
      new_version: ${{ needs.extract-version.outputs.version }}
    permissions:
      contents: write
      pull-requests: read
  
  pre-release-tests:
    name: Run Pre-Release Tests
    needs: extract-version
    uses: ./.github/workflows/pre-release-tests.yml
    with:
      version: ${{ needs.extract-version.outputs.version }}
    permissions:
      contents: read
  
  publish-python:
    name: Publish Python Package
    needs: [extract-version, pre-release-tests]
    uses: ./.github/workflows/publish-package.yml
    secrets: inherit  # pragma: allowlist secret
    permissions:
      contents: write
      id-token: write
  
  publish-vscode:
    name: Publish VS Code Extension
    needs: [extract-version, pre-release-tests, publish-python]
    uses: ./.github/workflows/publish-vscode-extension.yml
    with:
      version: ${{ needs.extract-version.outputs.version }}
      vsix_artifact: vsix-package
    secrets:
      VSCODE_MARKETPLACE_PAT: ${{ secrets.VSCODE_MARKETPLACE_PAT }}  # pragma: allowlist secret
    permissions:
      contents: write
  
  rollback-on-failure:
    name: Rollback on Failure
    needs: [extract-version, publish-python, publish-vscode]
    if: failure()
    uses: ./.github/workflows/rollback-release.yml
    with:
      version: ${{ needs.extract-version.outputs.version }}
      python_published: ${{ needs.publish-python.result == 'success' }}
      vscode_published: ${{ needs.publish-vscode.result == 'success' }}
    secrets:
      PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}  # pragma: allowlist secret
      VSCODE_MARKETPLACE_PAT: ${{ secrets.VSCODE_MARKETPLACE_PAT }}  # pragma: allowlist secret
    permissions:
      contents: write
      issues: write
  
  release-summary:
    name: Release Summary
    needs: [extract-version, publish-python, publish-vscode]
    if: success()
    runs-on: ubuntu-latest
    
    steps:
      - name: Create release summary
        run: |
          echo "# ðŸŽ‰ Release v${{ needs.extract-version.outputs.version }} Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python Package" >> $GITHUB_STEP_SUMMARY
          echo "- **PyPI:** https://pypi.org/project/re-cue/${{ needs.extract-version.outputs.version }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **Install:** \`pip install re-cue==${{ needs.extract-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### VS Code Extension" >> $GITHUB_STEP_SUMMARY
          echo "- **Marketplace:** https://marketplace.visualstudio.com/items?itemName=cue3.re-cue" >> $GITHUB_STEP_SUMMARY
          echo "- **Install:** \`code --install-extension cue3.re-cue\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Resources" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release:** https://github.com/cue-3/re-cue/releases/tag/v${{ needs.extract-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changelog:** [CHANGELOG.md](https://github.com/cue-3/re-cue/blob/main/vscode-extension/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Both packages have been successfully published and are now available! ðŸš€" >> $GITHUB_STEP_SUMMARY
      
      - name: Send success notification
        uses: actions/github-script@v7
        with:
          script: |
            // Optional: Add success notification logic here
            // Could create a GitHub Discussion or send notifications
            console.log('Release v${{ needs.extract-version.outputs.version }} completed successfully');
