name: PR Label Check

on:
  pull_request:
    types: [opened, labeled, unlabeled, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-labels:
    name: Validate PR Labels
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for category label
        uses: actions/github-script@v7
        with:
          script: |
            const categoryLabels = [
              'type: breaking',
              'type: enhancement',
              'type: bug',
              'type: documentation',
              'type: dependencies',
              'type: chore',
              'type: security',
              'type: performance'
            ];
            
            const prLabels = context.payload.pull_request.labels.map(label => label.name);
            const hasCategoryLabel = categoryLabels.some(cat => prLabels.includes(cat));
            
            if (!hasCategoryLabel) {
              const comment = '## âš ï¸ Missing Category Label\n\n' +
                'This pull request requires at least one category label before it can be merged.\n\n' +
                '**Available category labels:**\n\n' +
                '| Label | Description | Changelog Section |\n' +
                '|-------|-------------|-------------------|\n' +
                '| `type: breaking` ðŸ’¥ | Breaking changes requiring major version bump | Breaking Changes |\n' +
                '| `type: enhancement` âœ¨ | New features and enhancements | Added |\n' +
                '| `type: bug` ðŸ› | Bug fixes | Fixed |\n' +
                '| `type: documentation` ðŸ“š | Documentation updates | Changed |\n' +
                '| `type: dependencies` â¬†ï¸ | Dependency updates | Dependencies |\n' +
                '| `type: chore` ðŸ”§ | Maintenance and chores | Maintenance |\n' +
                '| `type: security` ðŸ”’ | Security fixes | Security |\n' +
                '| `type: performance` âš¡ | Performance improvements | Performance |\n\n' +
                '**Please add at least one label** to this PR. You can add multiple labels if the PR covers multiple categories.\n\n' +
                '*This check will automatically pass once a category label is added.*';
              
              // Post comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
              
              // Fail the check
              core.setFailed('PR is missing a required category label');
            } else {
              console.log(`âœ“ PR has category label(s): ${prLabels.filter(l => categoryLabels.includes(l)).join(', ')}`);
              
              // Find and delete old bot comments about missing labels
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              });
              
              for (const comment of comments.data) {
                if (comment.user.type === 'Bot' && 
                    comment.body.includes('Missing Category Label')) {
                  await github.rest.issues.deleteComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: comment.id
                  });
                }
              }
            }
