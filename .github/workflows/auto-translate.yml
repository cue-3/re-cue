name: Auto-Translate Templates

on:
  push:
    branches:
      - main
    paths:
      - 'reverse-engineer-python/reverse_engineer/templates/en/**/*.md'
  workflow_dispatch:
    inputs:
      language:
        description: 'Language to translate (es, fr, de, ja, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - es
          - fr
          - de
          - ja
      force:
        description: 'Force re-translation of existing files'
        required: false
        default: false
        type: boolean

jobs:
  detect-changes:
    name: Detect Changed Templates
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.changed-files.outputs.all_changed_files }}
      has-changes: ${{ steps.changed-files.outputs.any_changed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            reverse-engineer-python/reverse_engineer/templates/en/**/*.md

      - name: List changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

  translate:
    name: Translate to ${{ matrix.lang }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lang: ${{ github.event.inputs.language == 'all' && fromJSON('["es", "fr", "de", "ja"]') || fromJSON(format('["{0}"]', github.event.inputs.language || 'es')) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd reverse-engineer-python
          pip install -r requirements.txt
          pip install -r requirements-translation.txt

      - name: Build glossary
        run: |
          cd reverse-engineer-python
          python scripts/build_glossary.py --verbose

      - name: Translate templates
        env:
          ANTHROPIC_TRANSLATION_API_KEY: ${{ secrets.ANTHROPIC_TRANSLATION_API_KEY }} # pragma: allowlist secret
        run: |
          cd reverse-engineer-python
          
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi
          
          python scripts/translate_templates.py \
            --lang ${{ matrix.lang }} \
            $FORCE_FLAG \
            --verbose

      - name: Validate translations
        run: |
          cd reverse-engineer-python
          python scripts/validate_translations.py --lang ${{ matrix.lang }} --verbose
        continue-on-error: true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat: auto-translate templates to ${{ matrix.lang }}'
          branch: auto-translate-${{ matrix.lang }}-${{ github.run_number }}
          delete-branch: true
          title: 'Auto-translate templates to ${{ matrix.lang }}'
          body: |
            ## Automated Template Translation
            
            This PR contains automated translations to **${{ matrix.lang }}** generated by Claude Opus.
            
            ### Changes
            - Language: ${{ matrix.lang }}
            - Triggered by: ${{ github.event_name }}
            - Run ID: ${{ github.run_id }}
            
            ### Validation
            The translations have been automatically validated for:
            - ✅ Jinja2 variable preservation
            - ✅ Annotation preservation  
            - ✅ Code block integrity
            - ✅ Markdown structure
            
            ### Review Checklist
            - [ ] Translation quality (natural phrasing)
            - [ ] Technical term consistency
            - [ ] Cultural appropriateness
            - [ ] Test with sample project
            
            ### Testing
            ```bash
            # Test with a sample project
            reverse-engineer --use-cases --lang ${{ matrix.lang }} /path/to/project
            ```
            
            ### Related
            - Workflow: ${{ github.workflow }}
            - Commit: ${{ github.sha }}
            
            ---
            *This PR was automatically created by the auto-translate workflow.*
            *Please review and merge if the translations are acceptable.*
            *Native speaker review is recommended for quality assurance.*
          labels: |
            automated
            translation
            ${{ matrix.lang }}
          assignees: ${{ github.actor }}

  notify:
    name: Notify Completion
    needs: translate
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "## Translation Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflow completed. Check individual jobs for results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the generated PRs" >> $GITHUB_STEP_SUMMARY
          echo "2. Test translations with sample projects" >> $GITHUB_STEP_SUMMARY
          echo "3. Request native speaker review if needed" >> $GITHUB_STEP_SUMMARY
          echo "4. Merge approved translations" >> $GITHUB_STEP_SUMMARY
